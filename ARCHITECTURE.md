# Study Planner Backend - Architecture Overview

## System Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                         Frontend                             │
│            (React / React Native / Web App)                  │
└─────────────────────────┬───────────────────────────────────┘
                          │ HTTP/REST API
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    FastAPI Backend                           │
│  ┌───────────────┐  ┌────────────────┐  ┌────────────────┐  │
│  │   Canvas      │  │    Gemini      │  │    Calendar    │  │
│  │   Service     │  │    Service     │  │    Service     │  │
│  └───────┬───────┘  └────────┬───────┘  └────────┬───────┘  │
└──────────┼──────────────────┼──────────────────┼────────────┘
           │                  │                  │
           ▼                  ▼                  ▼
    ┌──────────┐      ┌──────────┐      ┌──────────┐
    │  Canvas  │      │  Gemini  │      │  Google  │
    │   LMS    │      │    AI    │      │ Calendar │
    │   API    │      │   API    │      │   API    │
    └──────────┘      └──────────┘      └──────────┘
```

## Core Components

### 1. Main Application (`main.py`)

The FastAPI application server that:
- Exposes REST API endpoints
- Handles HTTP requests/responses
- Coordinates between services
- Manages CORS and middleware
- Provides automatic API documentation

**Key Endpoints:**
- `/canvas/*` - Canvas LMS operations
- `/study-plan/*` - AI study plan generation
- `/calendar/*` - Google Calendar operations

### 2. Canvas Service (`services/canvas_service.py`)

Integrates with Canvas LMS API to:
- Authenticate users
- Fetch upcoming assignments
- Retrieve course information
- Parse assignment details (due dates, types, points)

**Features:**
- Handles both to-do list and upcoming events
- Deduplicates assignments
- Classifies assignment types automatically
- Sorts by due date

### 3. Gemini Service (`services/gemini_service.py`)

Uses Google's Gemini AI to:
- Generate personalized study plans
- Break down assignments into tasks
- Schedule tasks intelligently
- Consider user preferences
- Prioritize based on multiple factors

**AI Capabilities:**
- Natural language understanding
- Smart time estimation
- Priority assignment
- Buffer time calculation
- Preference-aware scheduling

### 4. Calendar Service (`services/calendar_service.py`)

Manages Google Calendar integration:
- Creates study session events
- Checks for scheduling conflicts
- Finds free time slots
- Color-codes by priority
- Adds reminders and notifications

**Calendar Features:**
- Priority-based color coding
- Detailed event descriptions
- Multiple reminder types
- Conflict detection
- Event updating/deletion

## Data Flow

### Complete Study Plan Pipeline

```
1. User Request
   ↓
2. Fetch Canvas Assignments
   - Authenticate with Canvas
   - GET /api/v1/users/self/todo
   - GET /api/v1/users/self/upcoming_events
   - Parse and deduplicate
   ↓
3. Generate Study Plan with AI
   - Format assignments for Gemini
   - Include user preferences
   - Send to Gemini API
   - Parse JSON response
   - Create StudyTask objects
   ↓
4. Create Calendar Events
   - Authenticate with Google
   - For each task:
     * Calculate start/end times
     * Set priority colors
     * Add descriptions
     * Create calendar event
   ↓
5. Return Results
   - List of created events
   - Study plan summary
   - Total study time
```

## Data Models

### Assignment (Canvas)
```python
{
  "id": int,                    # Canvas assignment ID
  "title": str,                 # Assignment name
  "description": str,           # Assignment details
  "due_date": datetime,         # When it's due
  "course_name": str,           # Course name
  "course_id": int,             # Canvas course ID
  "assignment_type": str,       # exam/paper/problem_set
  "points": float,              # Point value
  "estimated_time": int         # Minutes (optional)
}
```

### StudyTask (Generated by AI)
```python
{
  "task_name": str,             # Specific task description
  "assignment_title": str,      # Parent assignment
  "course_name": str,           # Course
  "duration_minutes": int,      # How long to spend
  "suggested_date": str,        # YYYY-MM-DD
  "suggested_start_time": str,  # HH:MM (24-hour)
  "priority": str,              # high/medium/low
  "description": str,           # Detailed instructions
  "course_id": int,             # Canvas course ID
  "assignment_id": int          # Canvas assignment ID
}
```

### UserPreferences
```python
{
  "study_session_length": 90,         # Preferred session (mins)
  "break_frequency": 25,              # Pomodoro breaks
  "daily_study_hours": 4,             # Max per day
  "preferred_study_times": [          # Time blocks
    "09:00-12:00",
    "14:00-17:00"
  ],
  "buffer_days": 1,                   # Days before deadline
  "weekend_study": true               # Study on weekends?
}
```

## AI Prompt Engineering

The Gemini service uses carefully crafted prompts to generate high-quality study plans:

**Prompt Structure:**
1. **Context Setting**: Current date/time, user preferences
2. **Assignment Details**: Complete info for each assignment
3. **Instructions**: Specific guidelines for task breakdown
4. **Output Format**: JSON schema for consistent parsing
5. **Constraints**: Time limits, prioritization rules

**Key Prompt Elements:**
- Break down assignments into actionable tasks
- Estimate realistic time for each task
- Schedule with buffer time before deadlines
- Prioritize by due date, points, and difficulty
- Respect user preferences and study times
- Generate valid JSON output

## Authentication & Security

### Canvas Authentication
- Uses Bearer token authentication
- Token stored in environment variables
- Validated on first request
- Reused for subsequent calls

### Google OAuth 2.0
- Desktop app OAuth flow
- Credentials stored in `credentials.json`
- Access tokens in `token.json`
- Automatic token refresh
- Scopes: Calendar read/write

### Best Practices
- Never commit credentials to Git
- Use environment variables for secrets
- Implement rate limiting in production
- Add request validation
- Log security events

## Error Handling

The backend implements comprehensive error handling:

1. **Service-Level Errors**
   - API connection failures
   - Authentication errors
   - Invalid responses
   - Rate limiting

2. **Data Validation**
   - Pydantic models validate all inputs
   - Type checking
   - Required field enforcement
   - Format validation

3. **Graceful Degradation**
   - Fallback study plans if AI fails
   - Partial success reporting
   - Detailed error messages
   - Logging for debugging

## Performance Considerations

### Current Implementation
- Synchronous API calls
- No caching
- Single-threaded processing

### Recommended Improvements
1. **Caching**
   - Redis for assignment data
   - Cache AI responses
   - Rate limit token bucket

2. **Async Processing**
   - Background task queues
   - Webhooks for long operations
   - WebSocket updates

3. **Database**
   - PostgreSQL for persistence
   - Store user preferences
   - Track study completion
   - Historical analytics

## Scalability Path

### Phase 1: Single User (Current)
- Local development
- File-based credentials
- Direct API calls

### Phase 2: Multi-User
- Database for user data
- User authentication system
- Rate limiting per user
- Session management

### Phase 3: Production
- Horizontal scaling
- Load balancing
- Microservices architecture
- CDN for static assets
- Monitoring and logging

## Extension Points

The architecture is designed for easy extension:

### Additional LMS Integrations
- Blackboard
- Moodle
- Schoology
- Each needs new service class

### AI Model Alternatives
- OpenAI GPT-4
- Claude
- Local models (Llama)
- Swap in `gemini_service.py`

### Calendar Providers
- Microsoft Outlook
- Apple Calendar
- Any CalDAV server
- New service implementation

### Features to Add
- Email notifications
- Mobile push notifications
- Progress tracking
- Analytics dashboard
- Study group coordination
- Spaced repetition
- Focus time tracking

## Development Workflow

1. **Local Development**
   ```bash
   python main.py
   # Visit http://localhost:8000/docs
   ```

2. **Testing**
   ```bash
   python test_api.py
   ```

3. **Docker Development**
   ```bash
   docker-compose up
   ```

4. **Production Deployment**
   ```bash
   docker build -t study-planner .
   docker run -p 8000:8000 study-planner
   ```

## Monitoring & Debugging

### Logs
- Console output for development
- File logging for production
- Structured JSON logs recommended

### Metrics to Track
- API response times
- Success/failure rates
- AI generation quality
- Calendar event creation success
- User engagement

### Debug Tools
- FastAPI interactive docs
- Pydantic validation errors
- Python debugger (pdb)
- HTTP request logging

## Next Steps

To extend this backend:

1. **Add Database**: PostgreSQL for user data persistence
2. **Implement Auth**: JWT tokens for user authentication
3. **Add Caching**: Redis for performance
4. **Background Jobs**: Celery for async tasks
5. **WebSockets**: Real-time updates
6. **Analytics**: Track study patterns
7. **Mobile App**: React Native frontend
8. **CI/CD**: Automated testing and deployment

---

This architecture provides a solid foundation for an automated study planning system that can scale from personal use to production deployment.
